{% extends "base.html" %}

{% block title %}Monitoring Dashboard{% endblock %}

{% block content %}
<div class="container mx-auto p-4" x-data="monitoringDashboard()" x-init="init()">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">Monitoring Dashboard</h1>

    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white shadow-md rounded-lg p-6 text-center">
            <div class="text-gray-500 text-sm font-medium">Paragony w kolejce</div>
            <div class="text-4xl font-bold text-blue-600 mt-2" x-text="totalPending"></div>
        </div>
        <div class="bg-white shadow-md rounded-lg p-6 text-center">
            <div class="text-gray-500 text-sm font-medium">Paragony w trakcie</div>
            <div class="text-4xl font-bold text-yellow-600 mt-2" x-text="totalProcessing"></div>
        </div>
        <div class="bg-white shadow-md rounded-lg p-6 text-center">
            <div class="text-gray-500 text-sm font-medium">Paragony z błędem</div>
            <div class="text-4xl font-bold text-red-600 mt-2" x-text="totalErrors"></div>
        </div>
        <div class="bg-white shadow-md rounded-lg p-6 text-center">
            <div class="text-gray-500 text-sm font-medium">Średni czas przetwarzania</div>
            <div class="text-4xl font-bold text-green-600 mt-2" x-text="averageProcessingTime"></div>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="bg-white shadow-md rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Rozkład statusów paragonów</h2>
            <canvas id="statusChart"></canvas>
        </div>
        <div class="bg-white shadow-md rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Paragony na etapach przetwarzania</h2>
            <canvas id="stepChart"></canvas>
        </div>
    </div>

    <!-- Recent Errors Table -->
    <div class="bg-white shadow-md rounded-lg p-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">Ostatnie błędy</h2>
        <div x-show="errorReceipts.length === 0" class="text-gray-500 text-center py-4">Brak błędów w ostatnich paragonach.</div>
        <div x-show="errorReceipts.length > 0" class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sklep</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data zakupu</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Komunikat błędu</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ostatnia aktualizacja</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="receipt in errorReceipts" :key="receipt.id">
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                <a :href="`/inventory/receipts/${receipt.id}/`" class="text-blue-600 hover:text-blue-900" x-text="receipt.id"></a>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="receipt.store_name"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="receipt.purchased_at ? new Date(receipt.purchased_at).toLocaleDateString() : 'N/A'"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="receipt.error_message"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="new Date(receipt.updated_at).toLocaleString()"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function monitoringDashboard() {
        return {
            statusCounts: {},
            stepCounts: {},
            errorReceipts: [],
            averageProcessingTime: '',
            totalPending: 0,
            totalProcessing: 0,
            totalErrors: 0,
            statusChart: null,
            stepChart: null,

            init() {
                this.statusCounts = JSON.parse('{{ status_counts_json|escapejs }}');
                this.stepCounts = JSON.parse('{{ step_counts_json|escapejs }}');
                this.errorReceipts = JSON.parse('{{ error_receipts_json|escapejs }}');
                this.averageProcessingTime = '{{ average_processing_time|escapejs }}';
                this.totalPending = {{ total_pending }};
                this.totalProcessing = {{ total_processing }};
                this.totalErrors = {{ total_errors }};

                this.renderCharts();
                setInterval(() => this.fetchData(), 30000); // Refresh every 30 seconds
            },

            renderCharts() {
                // Status Chart
                const statusCtx = document.getElementById('statusChart').getContext('2d');
                if (this.statusChart) this.statusChart.destroy();
                this.statusChart = new Chart(statusCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(this.statusCounts),
                        datasets: [{
                            data: Object.values(this.statusCounts),
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.6)', // pending
                                'rgba(255, 206, 86, 0.6)', // processing
                                'rgba(75, 192, 192, 0.6)', // completed
                                'rgba(255, 99, 132, 0.6)', // error
                                'rgba(153, 102, 255, 0.6)', // review_pending
                            ],
                            borderColor: [
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(255, 99, 132, 1)',
                                'rgba(153, 102, 255, 1)',
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: false,
                                text: 'Receipt Status Distribution'
                            }
                        }
                    }
                });

                // Step Chart
                const stepCtx = document.getElementById('stepChart').getContext('2d');
                if (this.stepChart) this.stepChart.destroy();
                this.stepChart = new Chart(stepCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(this.stepCounts),
                        datasets: [{
                            label: 'Number of Receipts',
                            data: Object.values(this.stepCounts),
                            backgroundColor: 'rgba(153, 102, 255, 0.6)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false,
                            },
                            title: {
                                display: false,
                                text: 'Receipts by Processing Step'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            },

            async fetchData() {
                try {
                    const response = await fetch('/inventory/api/monitoring_data/'); // This endpoint needs to be created
                    if (!response.ok) {
                        throw new Error('Failed to fetch monitoring data.');
                    }
                    const data = await response.json();

                    this.statusCounts = data.status_counts;
                    this.stepCounts = data.step_counts;
                    this.errorReceipts = data.error_receipts;
                    this.averageProcessingTime = data.average_processing_time;
                    this.totalPending = data.total_pending;
                    this.totalProcessing = data.total_processing;
                    this.totalErrors = data.total_errors;

                    this.renderCharts(); // Re-render charts with new data
                } catch (error) {
                    console.error('Error fetching monitoring data:', error);
                }
            }
        }
    }
</script>
{% endblock %}