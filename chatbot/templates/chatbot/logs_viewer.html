{% extends 'chatbot/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .log-container {
        background: #1e1e1e;
        color: #d4d4d4;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        line-height: 1.4;
        border-radius: 4px;
        max-height: 600px;
        overflow-y: auto;
        padding: 15px;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    
    .log-controls {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    
    .log-file-selector {
        margin-bottom: 10px;
    }
    
    .log-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .log-status {
        padding: 5px 10px;
        border-radius: 3px;
        font-size: 12px;
        font-weight: bold;
    }
    
    .status-connected {
        background: #d4edda;
        color: #155724;
    }
    
    .status-disconnected {
        background: #f8d7da;
        color: #721c24;
    }
    
    .status-loading {
        background: #fff3cd;
        color: #856404;
    }
    
    .search-results {
        max-height: 300px;
        overflow-y: auto;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        margin-top: 10px;
    }
    
    .search-result-item {
        padding: 8px 12px;
        border-bottom: 1px solid #dee2e6;
        cursor: pointer;
    }
    
    .search-result-item:hover {
        background: #e9ecef;
    }
    
    .search-result-item:last-child {
        border-bottom: none;
    }
    
    .line-number {
        color: #6c757d;
        font-weight: bold;
        margin-right: 10px;
    }
    
    mark {
        background: #ffeb3b;
        padding: 1px 2px;
    }
    
    .log-level-ERROR {
        color: #ff4444;
        font-weight: bold;
    }
    
    .log-level-WARNING {
        color: #ffaa00;
        font-weight: bold;
    }
    
    .log-level-INFO {
        color: #44ff44;
    }
    
    .log-level-DEBUG {
        color: #4444ff;
    }
    
    .auto-scroll-toggle {
        position: sticky;
        bottom: 10px;
        right: 10px;
        z-index: 10;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2>{{ title }}</h2>
            
            <!-- Log Controls -->
            <div class="log-controls">
                <div class="row">
                    <div class="col-md-6">
                        <div class="log-file-selector">
                            <label for="logFileSelect" class="form-label">Wybierz plik logów:</label>
                            <select id="logFileSelect" class="form-select">
                                {% for log_file in log_files %}
                                <option value="{{ log_file.name }}" 
                                        data-type="{{ log_file.type }}" 
                                        data-size="{{ log_file.size }}">
                                    {{ log_file.name }} 
                                    {% if log_file.type == 'systemd' %}(System Journal){% endif %}
                                    {% if log_file.size > 0 %}({{ log_file.size|filesizeformat }}){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="log-actions">
                            <button id="loadLogsBtn" class="btn btn-primary btn-sm">
                                <i class="bi bi-arrow-clockwise"></i> Załaduj logi
                            </button>
                            <button id="toggleStreamBtn" class="btn btn-success btn-sm">
                                <i class="bi bi-play-fill"></i> Start Live
                            </button>
                            <button id="clearLogsBtn" class="btn btn-secondary btn-sm">
                                <i class="bi bi-trash"></i> Wyczyść
                            </button>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="autoScrollCheck" checked>
                                <label class="form-check-label" for="autoScrollCheck">
                                    Auto-scroll
                                </label>
                            </div>
                            <span id="logStatus" class="log-status status-disconnected">Disconnected</span>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-2">
                            <label for="searchInput" class="form-label">Wyszukaj w logach:</label>
                            <div class="input-group">
                                <input type="text" id="searchInput" class="form-control" placeholder="Wprowadź termin wyszukiwania...">
                                <button id="searchBtn" class="btn btn-outline-secondary">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="caseSensitiveCheck">
                            <label class="form-check-label" for="caseSensitiveCheck">
                                Rozróżniaj wielkość liter
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Search Results -->
                <div id="searchResults" class="search-results" style="display: none;">
                    <div id="searchResultsContent"></div>
                </div>
            </div>
            
            <!-- Log Container -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span id="logTitle">System Logs</span>
                    <small id="logInfo" class="text-muted">Ready</small>
                </div>
                <div class="card-body p-0">
                    <div id="logContainer" class="log-container">
                        <div class="text-center text-muted">
                            <i class="bi bi-file-text fa-3x mb-3"></i>
                            <p>Wybierz plik logów i kliknij "Załaduj logi" aby rozpocząć</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
class LogViewer {
    constructor() {
        this.isStreaming = false;
        this.eventSource = null;
        this.autoScroll = true;
        this.lastUpdateTime = null;
        
        this.initializeEventListeners();
        this.updateLogInfo();
    }
    
    initializeEventListeners() {
        // Control buttons
        document.getElementById('loadLogsBtn').addEventListener('click', () => this.loadLogs());
        document.getElementById('toggleStreamBtn').addEventListener('click', () => this.toggleStreaming());
        document.getElementById('clearLogsBtn').addEventListener('click', () => this.clearLogs());
        document.getElementById('searchBtn').addEventListener('click', () => this.searchLogs());
        
        // Auto-scroll toggle
        document.getElementById('autoScrollCheck').addEventListener('change', (e) => {
            this.autoScroll = e.target.checked;
        });
        
        // Search on Enter
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                this.searchLogs();
            }
        });
        
        // Log file selection change
        document.getElementById('logFileSelect').addEventListener('change', () => {
            this.updateLogInfo();
            if (this.isStreaming) {
                this.stopStreaming();
            }
        });
    }
    
    updateLogInfo() {
        const select = document.getElementById('logFileSelect');
        const selectedOption = select.options[select.selectedIndex];
        const fileName = selectedOption.value;
        const fileType = selectedOption.dataset.type;
        const fileSize = selectedOption.dataset.size;
        
        document.getElementById('logTitle').textContent = `${fileName} (${fileType})`;
        document.getElementById('logInfo').textContent = `Size: ${this.formatBytes(fileSize)}`;
    }
    
    async loadLogs() {
        const select = document.getElementById('logFileSelect');
        const selectedOption = select.options[select.selectedIndex];
        const fileName = selectedOption.value;
        const fileType = selectedOption.dataset.type;
        
        this.setStatus('loading', 'Loading logs...');
        
        try {
            const response = await fetch(`/logs/stream/?file=${encodeURIComponent(fileName)}&type=${fileType}&lines=200`);
            const data = await response.json();
            
            if (data.success) {
                this.displayLogs(data.content);
                this.setStatus('connected', 'Logs loaded');
                this.lastUpdateTime = new Date();
            } else {
                this.displayError(`Error loading logs: ${data.error}`);
                this.setStatus('disconnected', 'Error');
            }
        } catch (error) {
            this.displayError(`Network error: ${error.message}`);
            this.setStatus('disconnected', 'Network error');
        }
    }
    
    toggleStreaming() {
        if (this.isStreaming) {
            this.stopStreaming();
        } else {
            this.startStreaming();
        }
    }
    
    startStreaming() {
        const select = document.getElementById('logFileSelect');
        const selectedOption = select.options[select.selectedIndex];
        const fileName = selectedOption.value;
        const fileType = selectedOption.dataset.type;
        
        const url = `/logs/stream/?file=${encodeURIComponent(fileName)}&type=${fileType}&follow=true`;
        
        this.eventSource = new EventSource(url);
        this.isStreaming = true;
        
        this.eventSource.onopen = () => {
            this.setStatus('connected', 'Live streaming...');
            document.getElementById('toggleStreamBtn').innerHTML = '<i class="bi bi-stop-fill"></i> Stop Live';
            document.getElementById('toggleStreamBtn').className = 'btn btn-danger btn-sm';
        };
        
        this.eventSource.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                if (data.content) {
                    this.appendLogs(data.content);
                    this.lastUpdateTime = new Date(data.timestamp * 1000);
                }
                if (data.error) {
                    this.displayError(`Stream error: ${data.error}`);
                }
            } catch (e) {
                console.error('Error parsing stream data:', e);
            }
        };
        
        this.eventSource.onerror = () => {
            this.setStatus('disconnected', 'Stream error');
            this.stopStreaming();
        };
    }
    
    stopStreaming() {
        if (this.eventSource) {
            this.eventSource.close();
            this.eventSource = null;
        }
        
        this.isStreaming = false;
        this.setStatus('disconnected', 'Stream stopped');
        document.getElementById('toggleStreamBtn').innerHTML = '<i class="bi bi-play-fill"></i> Start Live';
        document.getElementById('toggleStreamBtn').className = 'btn btn-success btn-sm';
    }
    
    displayLogs(content) {
        const container = document.getElementById('logContainer');
        container.innerHTML = this.formatLogContent(content);
        this.scrollToBottom();
    }
    
    appendLogs(content) {
        const container = document.getElementById('logContainer');
        const formattedContent = this.formatLogContent(content);
        container.innerHTML += formattedContent;
        
        if (this.autoScroll) {
            this.scrollToBottom();
        }
    }
    
    formatLogContent(content) {
        // Apply syntax highlighting for log levels
        return content
            .replace(/\bERROR\b/g, '<span class="log-level-ERROR">ERROR</span>')
            .replace(/\bWARNING\b/g, '<span class="log-level-WARNING">WARNING</span>')
            .replace(/\bINFO\b/g, '<span class="log-level-INFO">INFO</span>')
            .replace(/\bDEBUG\b/g, '<span class="log-level-DEBUG">DEBUG</span>');
    }
    
    clearLogs() {
        document.getElementById('logContainer').innerHTML = 
            '<div class="text-center text-muted"><i class="bi bi-file-text fa-3x mb-3"></i><p>Logs cleared</p></div>';
        document.getElementById('searchResults').style.display = 'none';
    }
    
    async searchLogs() {
        const searchTerm = document.getElementById('searchInput').value.trim();
        const caseSensitive = document.getElementById('caseSensitiveCheck').checked;
        const fileName = document.getElementById('logFileSelect').value;
        
        if (!searchTerm) {
            alert('Please enter a search term');
            return;
        }
        
        try {
            const response = await fetch('/logs/search/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCsrfToken()
                },
                body: JSON.stringify({
                    search_term: searchTerm,
                    log_file: fileName,
                    case_sensitive: caseSensitive
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.displaySearchResults(data.results, searchTerm);
            } else {
                alert(`Search error: ${data.error}`);
            }
        } catch (error) {
            alert(`Network error: ${error.message}`);
        }
    }
    
    displaySearchResults(results, searchTerm) {
        const container = document.getElementById('searchResultsContent');
        const resultsDiv = document.getElementById('searchResults');
        
        if (results.length === 0) {
            container.innerHTML = `<div class="p-3 text-muted">No results found for "${searchTerm}"</div>`;
        } else {
            container.innerHTML = results.map(result => `
                <div class="search-result-item" onclick="logViewer.scrollToLine(${result.line_number})">
                    <span class="line-number">Line ${result.line_number}:</span>
                    <span>${result.highlighted}</span>
                </div>
            `).join('');
        }
        
        resultsDiv.style.display = 'block';
    }
    
    scrollToLine(lineNumber) {
        // This is a simplified version - in a real implementation,
        // you'd need to track line numbers in the log display
        alert(`Would scroll to line ${lineNumber}`);
    }
    
    scrollToBottom() {
        const container = document.getElementById('logContainer');
        container.scrollTop = container.scrollHeight;
    }
    
    setStatus(type, message) {
        const statusElement = document.getElementById('logStatus');
        statusElement.className = `log-status status-${type}`;
        statusElement.textContent = message;
        
        // Update log info with timestamp
        if (this.lastUpdateTime) {
            document.getElementById('logInfo').textContent = 
                `Last update: ${this.lastUpdateTime.toLocaleTimeString()}`;
        }
    }
    
    displayError(message) {
        const container = document.getElementById('logContainer');
        container.innerHTML = `<div class="text-danger p-3"><i class="bi bi-exclamation-triangle"></i> ${message}</div>`;
    }
    
    formatBytes(bytes) {
        if (bytes === 0 || bytes === '0') return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    getCsrfToken() {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') {
                return value;
            }
        }
        return '';
    }
}

// Initialize log viewer when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    window.logViewer = new LogViewer();
});
</script>
{% endblock %}