{% extends 'chatbot/base.html' %}

{% block title %}Prze≈õlij Paragon{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-2xl mx-auto">
        <!-- Header Section -->
        <div class="text-center mb-8 animate-fade-in">
            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full mb-4 shadow-lg">
                <span class="text-3xl animate-bounce-gentle">üßæ</span>
            </div>
            <h1 class="text-4xl font-bold gradient-text mb-2">Prze≈õlij Paragon</h1>
            <p class="text-secondary-600 text-lg">Prze≈õlij zdjƒôcie paragonu, aby automatycznie dodaƒá produkty do swojej spi≈ºarni</p>
        </div>

        <!-- Upload Form Card -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-6 card-hover animate-slide-up border border-secondary-100">
            <form method="post" enctype="multipart/form-data" class="space-y-6">
                {% csrf_token %}
                
                <!-- File Upload Area -->
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-secondary-700 mb-3">
                        Wybierz zdjƒôcie paragonu
                    </label>
                    
                    <div class="relative border-2 border-dashed border-secondary-300 rounded-xl p-8 text-center hover:border-primary-400 transition-colors duration-300 bg-gradient-to-br from-primary-50/30 to-purple-50/30 file-drop-area cursor-pointer">
                        <!-- Hidden file input -->
                        <input type="file" name="receipt_file" accept=".jpg,.jpeg,.png,.webp,.pdf" id="id_receipt_file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                        
                        <div class="space-y-4 pointer-events-none">
                            <div class="mx-auto w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center">
                                <span class="text-2xl">üìé</span>
                            </div>
                            
                            <div>
                                <p class="text-secondary-600 text-lg font-medium mb-2">
                                    PrzeciƒÖgnij plik tutaj lub kliknij, aby wybraƒá
                                </p>
                                <p class="text-secondary-500 text-sm">
                                    Obs≈Çugujemy: JPG, PNG, WebP, PDF (maks. 10MB)
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="pt-4">
                    <button type="submit" id="submit-btn"
                            class="w-full bg-gradient-to-r from-primary-500 to-purple-600 hover:from-primary-600 hover:to-purple-700 text-white font-semibold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-300 flex items-center justify-center space-x-2 text-lg">
                        <span class="text-xl">üöÄ</span>
                        <span>Prze≈õlij i Przetw√≥rz</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Progress Tracking Section (initially hidden) -->
        <div id="progress-container" class="bg-white rounded-2xl shadow-xl p-8 mb-6 border border-secondary-100 hidden animate-slide-up">
            <h3 class="text-lg font-semibold text-secondary-800 mb-4 flex items-center">
                <span class="text-xl mr-2">‚è≥</span>
                Przetwarzanie paragonu
            </h3>
            
            <!-- Progress Bar -->
            <div class="mb-4">
                <div class="flex justify-between text-sm text-secondary-600 mb-2">
                    <span id="upload-status">Przygotowywanie...</span>
                    <span id="upload-percentage">0%</span>
                </div>
                <div class="w-full bg-secondary-200 rounded-full h-3 overflow-hidden">
                    <div id="upload-progress" class="bg-gradient-to-r from-primary-500 to-purple-600 h-3 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Status Details -->
            <div id="status-details" class="text-sm text-secondary-600">
                <p>Rozpoczynamy przetwarzanie Twojego paragonu...</p>
            </div>
        </div>

        <!-- How it Works -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 border border-secondary-100 animate-slide-up">
            <h3 class="text-lg font-semibold text-secondary-800 mb-4 flex items-center">
                <span class="text-xl mr-2">‚ÑπÔ∏è</span>
                Jak to dzia≈Ça?
            </h3>
            <div class="space-y-3 text-secondary-600">
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0 w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center text-xs font-semibold text-primary-600">1</div>
                    <span>Prze≈õlij zdjƒôcie paragonu z telefonu lub komputera</span>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0 w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center text-xs font-semibold text-primary-600">2</div>
                    <span>Nasza AI automatycznie rozpozna produkty i ceny</span>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0 w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center text-xs font-semibold text-primary-600">3</div>
                    <span>Zweryfikuj i dodaj produkty do swojej spi≈ºarni</span>
                </div>
            </div>
        </div>

        <!-- Navigation Links -->
        <div class="flex flex-col sm:flex-row gap-4 justify-center animate-slide-up">
            <a href="{% url 'inventory:inventory_by_location' location='pantry' %}" 
               class="inline-flex items-center justify-center px-6 py-3 bg-secondary-100 hover:bg-secondary-200 text-secondary-700 font-medium rounded-xl transition-all duration-300 transform hover:scale-105 space-x-2">
                <span>üè™</span>
                <span>Zobacz spi≈ºarniƒô</span>
            </a>
            
            <a href="{% url 'chatbot:dashboard' %}" 
               class="inline-flex items-center justify-center px-6 py-3 bg-secondary-100 hover:bg-secondary-200 text-secondary-700 font-medium rounded-xl transition-all duration-300 transform hover:scale-105 space-x-2">
                <span>üè†</span>
                <span>Wr√≥ƒá do dashboard</span>
            </a>
        </div>
    </div>
</div>

<!-- Custom Styles for File Input -->
<style>
    .file-drop-area {
        position: relative;
        overflow: hidden;
    }
    
    .file-drop-area:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
</style>

<script>
class ReceiptUploadManager {
    constructor() {
        this.fileInput = document.getElementById('id_receipt_file');
        this.uploadArea = document.querySelector('.file-drop-area');
        this.form = document.querySelector('form');
        this.submitBtn = document.getElementById('submit-btn');
        this.progressContainer = document.getElementById('progress-container');
        this.progressBar = document.getElementById('upload-progress');
        this.statusText = document.getElementById('upload-status');
        this.percentageText = document.getElementById('upload-percentage');
        this.statusDetails = document.getElementById('status-details');
        
        this.websocket = null;
        this.currentReceiptId = null;
        
        this.init();
    }
    
    init() {
        if (!this.fileInput || !this.uploadArea) {
            console.error('Required elements not found!');
            return;
        }
        
        this.setupFileHandling();
        this.setupFormSubmission();
    }
    
    setupFileHandling() {
        // Handle click to open file dialog
        this.uploadArea.addEventListener('click', (e) => {
            if (e.target === this.uploadArea || !e.target.matches('input[type="file"]')) {
                this.fileInput.click();
            }
        });
        
        // Handle drag and drop
        this.uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            this.uploadArea.classList.add('border-primary-500', 'bg-primary-50');
        });
        
        this.uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            this.uploadArea.classList.remove('border-primary-500', 'bg-primary-50');
        });
        
        this.uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            this.uploadArea.classList.remove('border-primary-500', 'bg-primary-50');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                this.fileInput.files = files;
                this.updateFileName(files[0].name);
            }
        });
        
        // Handle file selection
        this.fileInput.addEventListener('change', (e) => {
            if (this.fileInput.files.length > 0) {
                this.updateFileName(this.fileInput.files[0].name);
            }
        });
    }
    
    setupFormSubmission() {
        this.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!this.fileInput.files.length) {
                alert('Proszƒô wybraƒá plik paragonu');
                return;
            }
            
            await this.uploadReceipt();
        });
    }
    
    async uploadReceipt() {
        const formData = new FormData(this.form);
        
        try {
            // Show progress container
            this.showProgress();
            this.updateProgress(10, 'Przesy≈Çanie pliku...', 'Plik jest przesy≈Çany na serwer');
            
            const response = await fetch(this.form.action || window.location.pathname, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            });
            
            const result = await response.json();
            
            if (response.ok && result.receipt_id) {
                this.currentReceiptId = result.receipt_id;
                this.updateProgress(20, 'Plik przes≈Çany', 'Rozpoczynamy przetwarzanie...');
                
                // Setup WebSocket connection for real-time updates
                this.setupWebSocket(result.receipt_id);
                
            } else {
                this.showError(result.error || 'WystƒÖpi≈Ç b≈ÇƒÖd podczas przesy≈Çania pliku');
            }
            
        } catch (error) {
            console.error('Upload error:', error);
            this.showError('WystƒÖpi≈Ç b≈ÇƒÖd podczas przesy≈Çania pliku');
        }
    }
    
    setupWebSocket(receiptId) {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/receipt_status/${receiptId}/`;
        
        this.websocket = new WebSocket(wsUrl);
        
        this.websocket.onopen = () => {
            console.log('WebSocket connection established');
            this.updateProgress(25, 'Po≈ÇƒÖczono', 'Nas≈Çuchujemy na aktualizacje status');
        };
        
        this.websocket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            console.log('WebSocket message received:', data);
            
            if (data.type === 'receipt_status_update') {
                this.handleStatusUpdate(data);
            } else if (data.type === 'receipt_error') {
                this.handleError(data);
            }
        };
        
        this.websocket.onclose = () => {
            console.log('WebSocket connection closed');
        };
        
        this.websocket.onerror = (error) => {
            console.error('WebSocket error:', error);
            this.updateProgress(null, 'B≈ÇƒÖd po≈ÇƒÖczenia', 'Utracono po≈ÇƒÖczenie z serwerem');
        };
    }
    
    handleStatusUpdate(data) {
        let progress = data.progress || this.calculateProgress(data.status);
        let statusText = this.getStatusText(data.status);
        let detailText = data.message || this.getDetailText(data.status);
        
        this.updateProgress(progress, statusText, detailText);
        
        // If processing is complete, redirect after a delay
        if (data.status === 'completed' || data.status === 'ready_for_review') {
            setTimeout(() => {
                window.location.href = `/chatbot/receipts/${data.receipt_id}/review/`;
            }, 2000);
        }
    }
    
    handleError(data) {
        this.showError(data.message || 'WystƒÖpi≈Ç b≈ÇƒÖd podczas przetwarzania');
        if (this.websocket) {
            this.websocket.close();
        }
    }
    
    calculateProgress(status) {
        const progressMap = {
            'uploaded': 30,
            'processing': 40,
            'ocr_in_progress': 50,
            'ocr_completed': 65,
            'parsing_in_progress': 75,
            'parsing_completed': 85,
            'matching_in_progress': 90,
            'matching_completed': 95,
            'ready_for_review': 100,
            'completed': 100
        };
        return progressMap[status] || 40;
    }
    
    getStatusText(status) {
        const statusMap = {
            'uploaded': 'Przetwarzanie rozpoczƒôte',
            'processing': 'Przetwarzanie...',
            'ocr_in_progress': 'Rozpoznawanie tekstu...',
            'ocr_completed': 'Tekst rozpoznany',
            'parsing_in_progress': 'Analiza paragonu...',
            'parsing_completed': 'Paragon przeanalizowany',
            'matching_in_progress': 'Dopasowywanie produkt√≥w...',
            'matching_completed': 'Produkty dopasowane',
            'ready_for_review': 'Gotowe do przeglƒÖdu',
            'completed': 'Zako≈Ñczone'
        };
        return statusMap[status] || 'Przetwarzanie...';
    }
    
    getDetailText(status) {
        const detailMap = {
            'uploaded': 'Plik zosta≈Ç przes≈Çany i oczekuje na przetworzenie',
            'ocr_in_progress': 'AI rozpoznaje tekst z paragonu',
            'ocr_completed': 'Tekst zosta≈Ç pomy≈õlnie rozpoznany',
            'parsing_in_progress': 'Analizujemy strukturƒô paragonu i produkty',
            'parsing_completed': 'Produkty zosta≈Çy wyodrƒôbnione z paragonu',
            'matching_in_progress': 'Dopasowujemy produkty do bazy danych',
            'matching_completed': 'Produkty zosta≈Çy dopasowane',
            'ready_for_review': 'Mo≈ºesz teraz przejrzeƒá i zweryfikowaƒá wyniki',
            'completed': 'Paragon zosta≈Ç w pe≈Çni przetworzony'
        };
        return detailMap[status] || 'Trwa przetwarzanie paragonu...';
    }
    
    showProgress() {
        this.progressContainer.classList.remove('hidden');
        this.submitBtn.disabled = true;
        this.submitBtn.innerHTML = '<span class="text-xl">‚è≥</span><span>Przetwarzanie...</span>';
    }
    
    updateProgress(percentage, status, details) {
        if (percentage !== null) {
            this.progressBar.style.width = `${percentage}%`;
            this.percentageText.textContent = `${percentage}%`;
        }
        
        if (status) {
            this.statusText.textContent = status;
        }
        
        if (details) {
            this.statusDetails.innerHTML = `<p>${details}</p>`;
        }
    }
    
    showError(message) {
        this.progressBar.style.background = 'linear-gradient(to right, #ef4444, #dc2626)';
        this.statusText.textContent = 'B≈ÇƒÖd';
        this.statusText.classList.add('text-red-600');
        this.statusDetails.innerHTML = `<p class="text-red-600">${message}</p>`;
        
        // Re-enable form
        this.submitBtn.disabled = false;
        this.submitBtn.innerHTML = '<span class="text-xl">üöÄ</span><span>Spr√≥buj ponownie</span>';
    }
    
    updateFileName(name) {
        const uploadText = this.uploadArea.querySelector('p.text-secondary-600');
        if (uploadText) {
            uploadText.textContent = `Wybrany plik: ${name}`;
            uploadText.classList.remove('text-secondary-600');
            uploadText.classList.add('text-success-600', 'font-semibold');
        }
        
        // Update icon based on file type
        const icon = this.uploadArea.querySelector('.mx-auto span');
        const fileExtension = name.split('.').pop().toLowerCase();
        
        if (fileExtension === 'pdf') {
            icon.textContent = 'üìÑ';
        } else {
            icon.textContent = 'üñºÔ∏è';
        }
        
        // Change border color to show selection
        this.uploadArea.classList.remove('border-secondary-300');
        this.uploadArea.classList.add('border-success-500', 'bg-success-50/30');
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    new ReceiptUploadManager();
});
</script>
{% endblock %}
