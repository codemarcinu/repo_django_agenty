{% extends 'chatbot/base.html' %}
{% load static %}

{% block title %}Weryfikacja Paragonu{% endblock %}

{% block extra_head %}
    <!-- TomSelect CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
    <style>
        .product-row {
            border: 1px solid #e0e0e0;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .product-row .form-label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .tom-select .ts-control {
            border-color: #ced4da;
        }
        .tom-select .ts-dropdown {
            border-color: #ced4da;
        }
        .match-info {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 5px;
        }
        .match-info.exact { color: #28a745; }
        .match-info.fuzzy { color: #ffc107; }
        .match-info.alias { color: #17a2b8; }
        .match-info.created { color: #6f42c1; }
        .match-info.none, .match-info.error { color: #dc3545; }
    </style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1>Weryfikacja Paragonu #{{ receipt.id }}</h1>
    <p>Przejrzyj i edytuj wyodrębnione produkty przed dodaniem ich do spiżarni.</p>

    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">Surowy tekst z OCR</div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    <pre style="white-space: pre-wrap; font-size: 0.8em;">{{ receipt.raw_text.text }}</pre>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <form id="review-form">
                {% csrf_token %}
                <div id="products-container">
                    <!-- Products will be rendered here by JavaScript -->
                </div>

                <button type="button" class="btn btn-success mt-3" id="add-product-row">Dodaj produkt</button>
                <button type="submit" class="btn btn-primary mt-3">Potwierdź i Zapisz do Spiżarni</button>
            </form>
        </div>
    </div>
</div>

<!-- TomSelect JS -->
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

<script>
    const lineItemsData = JSON.parse('{{ line_items_json|escapejs }}');
    const productsContainer = document.getElementById('products-container');
    const reviewForm = document.getElementById('review-form');
    const addProductRowButton = document.getElementById('add-product-row');

    function createProductRow(item = {}) {
        const row = document.createElement('div');
        row.classList.add('row', 'mb-3', 'align-items-end', 'product-row');
        row.dataset.lineItemId = item.id || '';

        const initialProductName = item.product_name || '';
        const initialQuantity = item.quantity !== undefined ? item.quantity : 1.0;
        const initialUnitPrice = item.unit_price !== undefined ? item.unit_price : 0.00;
        const initialMatchedProductId = item.matched_product_id || '';
        const initialMatchedProductName = item.matched_product_name || '';
        const initialMatchConfidence = item.match_confidence !== undefined ? (item.match_confidence * 100).toFixed(1) : 'N/A';
        const initialMatchType = item.match_type || 'none';

        row.innerHTML = `
            <div class="col-md-5">
                <label class="form-label">Nazwa produktu</label>
                <select class="form-control product-name-select" placeholder="Wyszukaj lub wpisz..."></select>
                <input type="hidden" class="matched-product-id" value="${initialMatchedProductId}">
                <div class="match-info ${initialMatchType}">
                    Dopasowanie: ${initialMatchType} (${initialMatchConfidence}%)
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label">Ilość</label>
                <input type="number" step="0.01" class="form-control product-quantity" value="${initialQuantity}" required>
            </div>
            <div class="col-md-2">
                <label class="form-label">Cena jedn.</label>
                <input type="number" step="0.01" class="form-control product-unit-price" value="${initialUnitPrice}" required>
            </div>
            <div class="col-md-2">
                <label class="form-label">Suma</label>
                <input type="number" step="0.01" class="form-control product-line-total" value="${item.line_total !== undefined ? item.line_total : (initialQuantity * initialUnitPrice).toFixed(2)}" readonly>
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-danger remove-product-row">Usuń</button>
            </div>
        `;
        productsContainer.appendChild(row);

        const quantityInput = row.querySelector('.product-quantity');
        const unitPriceInput = row.querySelector('.product-unit-price');
        const lineTotalInput = row.querySelector('.product-line-total');

        const updateLineTotal = () => {
            const qty = parseFloat(quantityInput.value) || 0;
            const price = parseFloat(unitPriceInput.value) || 0;
            lineTotalInput.value = (qty * price).toFixed(2);
        };

        quantityInput.addEventListener('input', updateLineTotal);
        unitPriceInput.addEventListener('input', updateLineTotal);

        row.querySelector('.remove-product-row').addEventListener('click', () => {
            row.remove();
        });

        // Initialize TomSelect
        const selectElement = row.querySelector('.product-name-select');
        const hiddenProductIdInput = row.querySelector('.matched-product-id');

        new TomSelect(selectElement, {
            valueField: 'id',
            labelField: 'name',
            searchField: 'name',
            create: true, // Allow creating new products
            load: function(query, callback) {
                if (!query.length) return callback();
                fetch(`/api/products/search/?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        callback(data.products);
                    }).catch(() => callback());
            },
            render: {
                option: function(item, escape) {
                    return `<div>${escape(item.name)} <span class="text-muted">${item.category_name ? `(${escape(item.category_name)})` : ''}</span></div>`;
                },
                item: function(item, escape) {
                    return `<div>${escape(item.name)}</div>`;
                }
            },
            onInitialize: function() {
                // Set initial value if available
                if (initialMatchedProductId) {
                    this.addOption({id: initialMatchedProductId, name: initialMatchedProductName});
                    this.setValue(initialMatchedProductId);
                } else if (initialProductName) {
                    // If no matched product, but there's an initial product name from LLM, display it
                    this.addOption({id: initialProductName, name: initialProductName}); // Use name as ID for new items
                    this.setValue(initialProductName);
                }
            },
            onChange: function(value) {
                // If a product from the database is selected, store its ID
                if (typeof value === 'number' || (typeof value === 'string' && !isNaN(parseInt(value)))) {
                    hiddenProductIdInput.value = value;
                } else {
                    // If a new item is created (string value), clear the hidden ID
                    hiddenProductIdInput.value = '';
                }
            },
            onItemAdd: function(value, item) {
                // If a new item is created, ensure its name is used as the value for submission
                if (this.options[value] && this.options[value].$score === undefined) { // Check if it's a newly created item
                    hiddenProductIdInput.value = ''; // Clear matched product ID
                    // The product name will be taken from the TomSelect input's text value
                }
            }
        });
    }

    // Render initial products
    if (lineItemsData.length > 0) {
        lineItemsData.forEach(item => createProductRow(item));
    } else {
        createProductRow(); // Add an empty row if no data extracted
    }

    addProductRowButton.addEventListener('click', () => {
        createProductRow();
    });

    reviewForm.addEventListener('submit', async (event) => {
        event.preventDefault();

        const productsToSave = [];
        document.querySelectorAll('.product-row').forEach(row => {
            const lineItemId = row.dataset.lineItemId;
            const matchedProductId = row.querySelector('.matched-product-id').value;
            const productNameInput = row.querySelector('.product-name-select');
            const tomSelectInstance = productNameInput.tomselect;

            let finalProductName = tomSelectInstance.getValue();
            if (tomSelectInstance.options[finalProductName] && tomSelectInstance.options[finalProductName].$score === undefined) {
                // This is a newly created item in TomSelect, use its text value
                finalProductName = tomSelectInstance.getValue();
            } else if (tomSelectInstance.options[finalProductName]) {
                // This is an existing item, use its name
                finalProductName = tomSelectInstance.options[finalProductName].name;
            }

            productsToSave.push({
                id: lineItemId, // Send the line item ID back to the backend
                product_name: finalProductName, // The name displayed/selected by the user
                quantity: parseFloat(row.querySelector('.product-quantity').value),
                unit_price: parseFloat(row.querySelector('.product-unit-price').value),
                // line_total is calculated on backend
                matched_product_id: matchedProductId || null // Send null if no product matched/selected
            });
        });

        try {
            const response = await fetch(window.location.href, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(productsToSave)
            });

            const result = await response.json();
            if (result.success) {
                window.location.href = result.redirect_url;
            } else {
                alert('Błąd podczas zapisywania danych: ' + result.error);
            }
        } catch (error) {
            console.error('Error submitting form:', error);
            alert('Wystąpił błąd podczas wysyłania danych.');
        }
    });
</script>
{% endblock %}