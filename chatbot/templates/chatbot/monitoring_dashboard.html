{% extends 'chatbot/base.html' %}

{% block title %}Receipt Processing Monitoring{% endblock %}

{% block content %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div class="container mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-4xl font-bold gradient-text mb-2">Receipt Processing Monitoring</h1>
        <p class="text-secondary-600 text-lg">System health, performance metrics, and alerts</p>
    </div>

    {% if error %}
    <div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-6">
        <div class="flex items-center">
            <span class="text-red-500 text-xl mr-3">‚ùå</span>
            <div>
                <p class="font-semibold text-red-800">Error</p>
                <p class="text-red-600">{{ error }}</p>
            </div>
        </div>
    </div>
    {% else %}

    <!-- System Health Overview -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
        <!-- Overall Health Status -->
        <div class="bg-white rounded-2xl shadow-lg p-6 border border-secondary-100">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-secondary-800">System Health</h3>
                <div id="health-indicator" class="w-4 h-4 rounded-full 
                    {% if health_summary.status == 'healthy' %}bg-green-500{% elif health_summary.status == 'warning' %}bg-yellow-500{% elif health_summary.status == 'degraded' %}bg-orange-500{% else %}bg-red-500{% endif %}">
                </div>
            </div>
            <p id="health-status" class="text-2xl font-bold mb-2
                {% if health_summary.status == 'healthy' %}text-green-600{% elif health_summary.status == 'warning' %}text-yellow-600{% elif health_summary.status == 'degraded' %}text-orange-600{% else %}text-red-600{% endif %}">
                {{ health_summary.status|title }}
            </p>
            <p class="text-sm text-secondary-600">Last updated: <span id="last-updated">{{ health_summary.last_updated|date:"H:i:s" }}</span></p>
        </div>

        <!-- Success Rate -->
        <div class="bg-white rounded-2xl shadow-lg p-6 border border-secondary-100">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-secondary-800">Success Rate</h3>
                <span class="text-green-500 text-xl">‚úÖ</span>
            </div>
            <p id="success-rate" class="text-3xl font-bold text-green-600 mb-2">{{ metrics_24h.success_rate|floatformat:1 }}%</p>
            <p class="text-sm text-secondary-600">Last 24 hours</p>
        </div>

        <!-- Processing Time -->
        <div class="bg-white rounded-2xl shadow-lg p-6 border border-secondary-100">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-secondary-800">Avg Processing</h3>
                <span class="text-blue-500 text-xl">‚è±Ô∏è</span>
            </div>
            <p id="avg-processing-time" class="text-3xl font-bold text-blue-600 mb-2">
                {% if metrics_24h.avg_processing_time %}
                    {{ metrics_24h.avg_processing_time|floatformat:1 }}s
                {% else %}
                    N/A
                {% endif %}
            </p>
            <p class="text-sm text-secondary-600">Average time</p>
        </div>

        <!-- Current Queue -->
        <div class="bg-white rounded-2xl shadow-lg p-6 border border-secondary-100">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-secondary-800">Queue Status</h3>
                <span class="text-orange-500 text-xl">üìã</span>
            </div>
            <p id="queue-size" class="text-3xl font-bold text-orange-600 mb-2">{{ metrics_24h.pending_count }}</p>
            <p class="text-sm text-secondary-600">Pending receipts</p>
        </div>
    </div>

    <!-- Service Status Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Service Status -->
        <div class="bg-white rounded-2xl shadow-lg p-6 border border-secondary-100">
            <h3 class="text-xl font-semibold text-secondary-800 mb-4">Service Status</h3>
            <div class="space-y-4">
                <div class="flex items-center justify-between p-3 bg-secondary-50 rounded-lg">
                    <div class="flex items-center">
                        <div id="redis-indicator" class="w-3 h-3 rounded-full mr-3 {% if redis_status %}bg-green-500{% else %}bg-red-500{% endif %}"></div>
                        <span class="font-medium text-secondary-800">Redis</span>
                    </div>
                    <span id="redis-status-text" class="text-sm {% if redis_status %}text-green-600{% else %}text-red-600{% endif %}">
                        {% if redis_status %}Online{% else %}Offline{% endif %}
                    </span>
                </div>
                <div class="flex items-center justify-between p-3 bg-secondary-50 rounded-lg">
                    <div class="flex items-center">
                        <div id="ollama-indicator" class="w-3 h-3 rounded-full mr-3 {% if ollama_status %}bg-green-500{% else %}bg-red-500{% endif %}"></div>
                        <span class="font-medium text-secondary-800">Ollama</span>
                    </div>
                    <span id="ollama-status-text" class="text-sm {% if ollama_status %}text-green-600{% else %}text-red-600{% endif %}">
                        {% if ollama_status %}Online{% else %}Offline{% endif %}
                    </span>
                </div>
            </div>
        </div>

        <!-- Receipt Status Chart -->
        <div class="bg-white rounded-2xl shadow-lg p-6 border border-secondary-100">
            <h3 class="text-xl font-semibold text-secondary-800 mb-4">Receipt Status Distribution</h3>
            <div class="relative h-64">
                <canvas id="receiptStatusChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Detailed Metrics -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Processing Stats Chart -->
        <div class="bg-white rounded-2xl shadow-lg p-6 border border-secondary-100">
            <h3 class="text-xl font-semibold text-secondary-800 mb-4">Processing Statistics</h3>
            <div class="space-y-4">
                <!-- 24h Stats -->
                <div class="border-l-4 border-blue-500 pl-4">
                    <h4 class="font-semibold text-secondary-700">Last 24 Hours</h4>
                    <div class="grid grid-cols-2 gap-4 mt-2">
                        <div>
                            <p class="text-sm text-secondary-600">Total Receipts</p>
                            <p class="text-lg font-semibold">{{ metrics_24h.total_receipts }}</p>
                        </div>
                        <div>
                            <p class="text-sm text-secondary-600">Error Rate</p>
                            <p class="text-lg font-semibold text-red-600">{{ metrics_24h.error_rate|floatformat:1 }}%</p>
                        </div>
                        <div>
                            <p class="text-sm text-secondary-600">OCR Accuracy</p>
                            <p class="text-lg font-semibold text-green-600">{{ metrics_24h.ocr_accuracy|floatformat:1 }}%</p>
                        </div>
                        <div>
                            <p class="text-sm text-secondary-600">Processing Now</p>
                            <p class="text-lg font-semibold text-blue-600">{{ metrics_24h.current_processing }}</p>
                        </div>
                    </div>
                </div>

                <!-- 7d Stats -->
                <div class="border-l-4 border-green-500 pl-4">
                    <h4 class="font-semibold text-secondary-700">Last 7 Days</h4>
                    <div class="grid grid-cols-2 gap-4 mt-2">
                        <div>
                            <p class="text-sm text-secondary-600">Total Receipts</p>
                            <p class="text-lg font-semibold">{{ metrics_7d.total_receipts }}</p>
                        </div>
                        <div>
                            <p class="text-sm text-secondary-600">Success Rate</p>
                            <p class="text-lg font-semibold text-green-600">{{ metrics_7d.success_rate|floatformat:1 }}%</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Alerts -->
        <div class="bg-white rounded-2xl shadow-lg p-6 border border-secondary-100">
            <h3 class="text-xl font-semibold text-secondary-800 mb-4">Recent Alerts</h3>
            <div id="alerts-container" class="space-y-3 max-h-96 overflow-y-auto">
                {% if recent_alerts %}
                    {% for alert in recent_alerts %}
                    <div class="alert-item border-l-4 pl-4
                        {% if alert.severity == 'critical' %}border-red-500 bg-red-50{% elif alert.severity == 'high' %}border-orange-500 bg-orange-50{% elif alert.severity == 'medium' %}border-yellow-500 bg-yellow-50{% else %}border-blue-500 bg-blue-50{% endif %}
                        rounded-r-lg p-3">
                        <div class="flex items-start justify-between">
                            <div>
                                <p class="font-semibold text-secondary-800">{{ alert.title }}</p>
                                <p class="text-sm text-secondary-600 mt-1">{{ alert.message }}</p>
                                <p class="text-xs text-secondary-500 mt-2">{{ alert.timestamp|date:"Y-m-d H:i:s" }}</p>
                            </div>
                            <span class="text-xs px-2 py-1 rounded-full
                                {% if alert.severity == 'critical' %}bg-red-200 text-red-800{% elif alert.severity == 'high' %}bg-orange-200 text-orange-800{% elif alert.severity == 'medium' %}bg-yellow-200 text-yellow-800{% else %}bg-blue-200 text-blue-800{% endif %}">
                                {{ alert.severity|upper }}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-8">
                        <span class="text-green-500 text-4xl">‚úÖ</span>
                        <p class="text-secondary-600 mt-2">No alerts in the last 24 hours</p>
                        <p class="text-sm text-secondary-500">System is operating normally</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Real-time Performance Chart -->
    <div class="bg-white rounded-2xl shadow-lg p-6 border border-secondary-100 mb-8">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-secondary-800">Processing Timeline</h3>
            <div class="flex space-x-2">
                <button id="chart-7d" class="px-3 py-1 text-sm bg-blue-100 text-blue-800 rounded-lg active">7 Days</button>
                <button id="chart-30d" class="px-3 py-1 text-sm bg-secondary-100 text-secondary-600 rounded-lg">30 Days</button>
            </div>
        </div>
        <div id="timeline-chart" class="h-64">
            <canvas id="processing-chart" width="800" height="300"></canvas>
        </div>
    </div>

    {% endif %}
</div>

<script>
// Real-time updates for monitoring dashboard with Chart.js integration
class MonitoringDashboard {
    constructor() {
        this.updateInterval = 5000; // 5 seconds as requested
        this.receiptStatusChart = null;
        this.timelineChart = null;
        this.initializeCharts();
        this.startAutoUpdate();
    }

    async updateMonitoringStats() {
        try {
            const response = await fetch('/api/monitoring/stats/');
            const data = await response.json();
            
            // Update service statuses (Redis and Ollama indicators)
            this.updateServiceStatuses(data.service_statuses);
            
            // Update receipt statistics
            if (data.receipt_stats) {
                this.updateReceiptStats(data.receipt_stats);
            }
            
            // Update inventory statistics  
            if (data.inventory_stats) {
                this.updateInventoryStats(data.inventory_stats);
            }
            
            // Update agent statistics
            if (data.agent_stats) {
                this.updateAgentStats(data.agent_stats);
            }
            
            // Update last updated timestamp
            document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
            
        } catch (error) {
            console.error('Error updating monitoring stats:', error);
        }
    }

    updateServiceStatuses(serviceStatuses) {
        // Update Redis status
        const redisIndicator = document.getElementById('redis-indicator');
        const redisStatusText = document.getElementById('redis-status-text');
        
        if (redisIndicator && redisStatusText) {
            if (serviceStatuses.redis) {
                redisIndicator.className = 'w-3 h-3 rounded-full mr-3 bg-green-500';
                redisStatusText.className = 'text-sm text-green-600';
                redisStatusText.textContent = 'Online';
            } else {
                redisIndicator.className = 'w-3 h-3 rounded-full mr-3 bg-red-500';
                redisStatusText.className = 'text-sm text-red-600';
                redisStatusText.textContent = 'Offline';
            }
        }
        
        // Update Ollama status
        const ollamaIndicator = document.getElementById('ollama-indicator');
        const ollamaStatusText = document.getElementById('ollama-status-text');
        
        if (ollamaIndicator && ollamaStatusText) {
            if (serviceStatuses.ollama) {
                ollamaIndicator.className = 'w-3 h-3 rounded-full mr-3 bg-green-500';
                ollamaStatusText.className = 'text-sm text-green-600';
                ollamaStatusText.textContent = 'Online';
            } else {
                ollamaIndicator.className = 'w-3 h-3 rounded-full mr-3 bg-red-500';
                ollamaStatusText.className = 'text-sm text-red-600';
                ollamaStatusText.textContent = 'Offline';
            }
        }
    }

    updateReceiptStats(receiptStats) {
        // Update receipt status chart
        if (this.receiptStatusChart && receiptStats) {
            const statusData = [
                receiptStats.completed || 0,
                receiptStats.processing || 0, 
                receiptStats.pending || 0,
                receiptStats.error || 0
            ];
            
            this.receiptStatusChart.data.datasets[0].data = statusData;
            this.receiptStatusChart.update();
        }
        
        // Update metric displays
        if (receiptStats.success_rate !== undefined) {
            const successRateElement = document.getElementById('success-rate');
            if (successRateElement) {
                successRateElement.textContent = `${receiptStats.success_rate.toFixed(1)}%`;
            }
        }
        
        if (receiptStats.pending_count !== undefined) {
            const queueSizeElement = document.getElementById('queue-size');
            if (queueSizeElement) {
                queueSizeElement.textContent = receiptStats.pending_count;
            }
        }
        
        if (receiptStats.avg_processing_time !== undefined) {
            const avgProcessingElement = document.getElementById('avg-processing-time');
            if (avgProcessingElement) {
                avgProcessingElement.textContent = receiptStats.avg_processing_time ? 
                    `${receiptStats.avg_processing_time.toFixed(1)}s` : 'N/A';
            }
        }
    }

    updateInventoryStats(inventoryStats) {
        // Implementation for inventory stats update if needed
        console.log('Inventory stats updated:', inventoryStats);
    }

    updateAgentStats(agentStats) {
        // Implementation for agent stats update if needed  
        console.log('Agent stats updated:', agentStats);
    }

    async updateAlerts() {
        try {
            const response = await fetch('/monitoring/api/alerts/');
            const data = await response.json();
            
            const alertsContainer = document.getElementById('alerts-container');
            if (alertsContainer && data.alerts) {
                if (data.alerts.length === 0) {
                    alertsContainer.innerHTML = `
                        <div class="text-center py-8">
                            <span class="text-green-500 text-4xl">‚úÖ</span>
                            <p class="text-secondary-600 mt-2">No alerts in the last 24 hours</p>
                            <p class="text-sm text-secondary-500">System is operating normally</p>
                        </div>
                    `;
                } else {
                    alertsContainer.innerHTML = data.alerts.map(alert => `
                        <div class="alert-item border-l-4 pl-4 ${this.getAlertClass(alert.severity)} rounded-r-lg p-3">
                            <div class="flex items-start justify-between">
                                <div>
                                    <p class="font-semibold text-secondary-800">${alert.title}</p>
                                    <p class="text-sm text-secondary-600 mt-1">${alert.message}</p>
                                    <p class="text-xs text-secondary-500 mt-2">${new Date(alert.timestamp).toLocaleString()}</p>
                                </div>
                                <span class="text-xs px-2 py-1 rounded-full ${this.getSeverityBadgeClass(alert.severity)}">
                                    ${alert.severity.toUpperCase()}
                                </span>
                            </div>
                        </div>
                    `).join('');
                }
            }
        } catch (error) {
            console.error('Error updating alerts:', error);
        }
    }

    getAlertClass(severity) {
        const classes = {
            'critical': 'border-red-500 bg-red-50',
            'high': 'border-orange-500 bg-orange-50', 
            'medium': 'border-yellow-500 bg-yellow-50',
            'low': 'border-blue-500 bg-blue-50'
        };
        return classes[severity] || 'border-secondary-500 bg-secondary-50';
    }

    getSeverityBadgeClass(severity) {
        const classes = {
            'critical': 'bg-red-200 text-red-800',
            'high': 'bg-orange-200 text-orange-800',
            'medium': 'bg-yellow-200 text-yellow-800',
            'low': 'bg-blue-200 text-blue-800'
        };
        return classes[severity] || 'bg-secondary-200 text-secondary-800';
    }

    initializeCharts() {
        // Initialize Receipt Status Pie Chart
        const receiptStatusCtx = document.getElementById('receiptStatusChart');
        if (receiptStatusCtx) {
            this.receiptStatusChart = new Chart(receiptStatusCtx, {
                type: 'pie',
                data: {
                    labels: ['Completed', 'Processing', 'Pending', 'Error'],
                    datasets: [{
                        data: [0, 0, 0, 0], // Will be updated by updateMonitoringStats
                        backgroundColor: [
                            '#10B981', // Green for completed
                            '#3B82F6', // Blue for processing  
                            '#F59E0B', // Orange for pending
                            '#EF4444'  // Red for error
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Initialize Timeline Chart with Chart.js
        this.initializeTimelineChart();
    }

    async initializeTimelineChart() {
        try {
            const response = await fetch('/monitoring/api/timeline/?days=7');
            const data = await response.json();
            
            const timelineCtx = document.getElementById('processing-chart');
            if (timelineCtx && data.timeline) {
                this.timelineChart = new Chart(timelineCtx, {
                    type: 'line',
                    data: {
                        labels: data.timeline.map(d => new Date(d.date).toLocaleDateString()),
                        datasets: [{
                            label: 'Total Receipts',
                            data: data.timeline.map(d => d.total),
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true
                        }, {
                            label: 'Completed',
                            data: data.timeline.map(d => d.completed),
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Error initializing timeline chart:', error);
        }
    }

    async updateTimelineChart(days) {
        try {
            const response = await fetch(`/monitoring/api/timeline/?days=${days}`);
            const data = await response.json();
            
            if (this.timelineChart && data.timeline) {
                this.timelineChart.data.labels = data.timeline.map(d => new Date(d.date).toLocaleDateString());
                this.timelineChart.data.datasets[0].data = data.timeline.map(d => d.total);
                this.timelineChart.data.datasets[1].data = data.timeline.map(d => d.completed);
                this.timelineChart.update();
            }
        } catch (error) {
            console.error('Error updating timeline chart:', error);
        }
    }

    startAutoUpdate() {
        // Initial update
        this.updateMonitoringStats();
        this.updateAlerts();
        
        // Set up periodic updates every 5 seconds
        setInterval(() => {
            this.updateMonitoringStats();
            this.updateAlerts();
        }, this.updateInterval);
    }
}

// Initialize dashboard when page loads
document.addEventListener('DOMContentLoaded', () => {
    const dashboard = new MonitoringDashboard();
    
    // Chart time period buttons
    document.getElementById('chart-7d')?.addEventListener('click', async () => {
        document.getElementById('chart-7d').className = 'px-3 py-1 text-sm bg-blue-100 text-blue-800 rounded-lg';
        document.getElementById('chart-30d').className = 'px-3 py-1 text-sm bg-secondary-100 text-secondary-600 rounded-lg';
        await dashboard.updateTimelineChart(7);
    });
    
    document.getElementById('chart-30d')?.addEventListener('click', async () => {
        document.getElementById('chart-30d').className = 'px-3 py-1 text-sm bg-blue-100 text-blue-800 rounded-lg';
        document.getElementById('chart-7d').className = 'px-3 py-1 text-sm bg-secondary-100 text-secondary-600 rounded-lg';
        await dashboard.updateTimelineChart(30);
    });
});
</script>
{% endblock %}