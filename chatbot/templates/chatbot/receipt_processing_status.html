{% extends 'chatbot/base.html' %}

{% block title %}Status Przetwarzania Paragonu{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-2xl mx-auto">
        <!-- Header Section -->
        <div class="text-center mb-8 animate-fade-in">
            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-r from-blue-500 to-indigo-500 rounded-full mb-4 shadow-lg">
                <span class="text-3xl animate-pulse">‚ö°</span>
            </div>
            <h1 class="text-4xl font-bold gradient-text mb-2">Przetwarzanie Paragonu</h1>
            <p class="text-secondary-600 text-lg">Paragon ID: <span class="font-semibold text-primary-600">#{{ receipt.id }}</span></p>
        </div>

        <!-- Status Card -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-6 border border-secondary-100 animate-slide-up">
            <!-- Current Status -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-xl font-semibold text-secondary-800">Status</h2>
                    <div id="status-indicator" class="w-3 h-3 bg-blue-500 rounded-full animate-pulse"></div>
                </div>
                <div id="status-message" class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-200">
                    <p class="text-lg font-medium text-blue-800" id="current-status">{{ receipt.get_status_display }}</p>
                    <p class="text-sm text-blue-600 mt-1" id="status-description">{{ receipt.processing_notes|default:"Inicjalizacja przetwarzania..." }}</p>
                </div>
                
                <!-- Error Message -->
                <div id="error-message" class="bg-gradient-to-r from-red-50 to-pink-50 rounded-xl p-4 border border-red-200 mt-4" style="display:none;">
                    <div class="flex items-center">
                        <span class="text-red-500 text-xl mr-3">‚ùå</span>
                        <div>
                            <p class="font-semibold text-red-800">WystƒÖpi≈Ç b≈ÇƒÖd</p>
                            <p class="text-red-600" id="error-text"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="mb-6">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-secondary-700">Postƒôp</span>
                    <span class="text-sm font-medium text-secondary-700" id="progress-text">0%</span>
                </div>
                <div class="w-full bg-secondary-200 rounded-full h-3 overflow-hidden">
                    <div id="progress-bar" class="bg-gradient-to-r from-blue-500 to-indigo-500 h-3 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                </div>
            </div>

            <!-- Processing Steps -->
            <div class="space-y-3">
                <h3 class="text-lg font-semibold text-secondary-800 mb-4">Etapy przetwarzania</h3>
                
                <div class="processing-step" data-step="pending_ocr">
                    <div class="flex items-center space-x-3">
                        <div class="step-indicator w-8 h-8 rounded-full border-2 border-secondary-300 flex items-center justify-center">
                            <span class="step-number text-sm font-semibold text-secondary-500">1</span>
                            <span class="step-check text-green-500 hidden">‚úì</span>
                        </div>
                        <div>
                            <p class="font-medium text-secondary-800">Przes≈Çanie pliku</p>
                            <p class="text-sm text-secondary-600">Plik zosta≈Ç pomy≈õlnie przes≈Çany na serwer</p>
                        </div>
                    </div>
                </div>

                <div class="processing-step" data-step="ocr_completed">
                    <div class="flex items-center space-x-3">
                        <div class="step-indicator w-8 h-8 rounded-full border-2 border-secondary-300 flex items-center justify-center">
                            <span class="step-number text-sm font-semibold text-secondary-500">2</span>
                            <span class="step-check text-green-500 hidden">‚úì</span>
                            <span class="step-spinner hidden">
                                <svg class="w-4 h-4 animate-spin text-blue-500" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </span>
                        </div>
                        <div>
                            <p class="font-medium text-secondary-800">Rozpoznawanie tekstu (OCR)</p>
                            <p class="text-sm text-secondary-600">Wyodrƒôbnianie tekstu z obrazu paragonu</p>
                        </div>
                    </div>
                </div>

                <div class="processing-step" data-step="parsing_completed">
                    <div class="flex items-center space-x-3">
                        <div class="step-indicator w-8 h-8 rounded-full border-2 border-secondary-300 flex items-center justify-center">
                            <span class="step-number text-sm font-semibold text-secondary-500">3</span>
                            <span class="step-check text-green-500 hidden">‚úì</span>
                            <span class="step-spinner hidden">
                                <svg class="w-4 h-4 animate-spin text-blue-500" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </span>
                        </div>
                        <div>
                            <p class="font-medium text-secondary-800">Analiza AI</p>
                            <p class="text-sm text-secondary-600">Sztuczna inteligencja analizuje i wyodrƒôbnia produkty</p>
                        </div>
                    </div>
                </div>

                <div class="processing-step" data-step="matching_completed">
                    <div class="flex items-center space-x-3">
                        <div class="step-indicator w-8 h-8 rounded-full border-2 border-secondary-300 flex items-center justify-center">
                            <span class="step-number text-sm font-semibold text-secondary-500">4</span>
                            <span class="step-check text-green-500 hidden">‚úì</span>
                        </div>
                        <div>
                            <p class="font-medium text-secondary-800">Gotowe do weryfikacji</p>
                            <p class="text-sm text-secondary-600">Sprawd≈∫ i zatwierd≈∫ wyodrƒôbnione produkty</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Information Card -->
        <div class="bg-white rounded-2xl shadow-lg p-6 border border-secondary-100 animate-slide-up">
            <div class="flex items-center space-x-3 mb-3">
                <span class="text-xl">üí°</span>
                <h3 class="text-lg font-semibold text-secondary-800">Co siƒô dzieje?</h3>
            </div>
            <div class="text-secondary-600 space-y-2" id="process-info">
                <p>Tw√≥j paragon jest obecnie przetwarzany przez nasz system AI. Proces sk≈Çada siƒô z kilku etap√≥w, aby zapewniƒá najlepszƒÖ jako≈õƒá rozpoznawania produkt√≥w.</p>
            </div>
        </div>
    </div>
</div>

<script>
    const receiptId = {{ receipt.id }};
    const initialStatus = "{{ receipt.status }}";
    const initialProcessingNotes = "{{ receipt.processing_notes|escapejs }}";

    const currentStatusSpan = document.getElementById('current-status');
    const statusDescription = document.getElementById('status-description');
    const errorMessageDiv = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const statusIndicator = document.getElementById('status-indicator');
    const processInfo = document.getElementById('process-info');

    // Real-time WebSocket connection for live updates
    class ReceiptUploadManager {
        constructor(receiptId) {
            this.receiptId = receiptId;
            this.ws = null;
            this.isPollingFallback = false;
            this.reconnectAttempts = 0;
            this.maxReconnectAttempts = 5;
            this.connectWebSocket();
        }

        connectWebSocket() {
            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/receipt-status/${this.receiptId}/`;
                
                this.ws = new WebSocket(wsUrl);
                this.setupEventHandlers();
            } catch (error) {
                console.error('WebSocket connection failed:', error);
                this.fallbackToPolling();
            }
        }

        setupEventHandlers() {
            this.ws.onopen = () => {
                console.log('WebSocket connected successfully');
                this.reconnectAttempts = 0;
                this.isPollingFallback = false;
            };

            this.ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('Received WebSocket message:', data);
                    
                    if (data.type === 'status_update') {
                        this.updateProgressBar(data.status, data.progress, data.status_display);
                        
                        // Handle completion or redirect
                        if (data.redirect_url && (data.status === 'ready_for_review' || data.status === 'completed')) {
                            setTimeout(() => {
                                window.location.href = data.redirect_url;
                            }, 2000);
                        }
                    } else if (data.type === 'error') {
                        this.handleError(data.message);
                    }
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                }
            };

            this.ws.onclose = (event) => {
                console.log('WebSocket closed:', event);
                if (!event.wasClean && this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    console.log(`Attempting to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`);
                    setTimeout(() => this.connectWebSocket(), 2000 * this.reconnectAttempts);
                } else {
                    console.log('Falling back to polling');
                    this.fallbackToPolling();
                }
            };

            this.ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        updateProgressBar(status, progress, statusDisplay) {
            const stages = {
                'uploaded': 'Przes≈Çano plik',
                'pending_ocr': 'Przes≈Çano plik',
                'processing_ocr': 'Rozpoznawanie tekstu...',
                'ocr_in_progress': 'Rozpoznawanie tekstu...',
                'ocr_completed': 'Tekst rozpoznany',
                'ocr_done': 'Tekst rozpoznany',
                'processing_parsing': 'Analiza AI...',
                'llm_in_progress': 'Analiza AI...',
                'llm_done': 'Analiza zako≈Ñczona',
                'parsing_completed': 'Analiza zako≈Ñczona',
                'matching': 'Dopasowywanie produkt√≥w...',
                'ready_for_review': 'Gotowe do weryfikacji',
                'completed': 'Gotowe!'
            };

            const displayText = stages[status] || statusDisplay || status;
            updateStatus(status, displayText);

            if (progress !== undefined) {
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `${progress}%`;
            }
        }

        handleError(message) {
            updateStatus('error', message);
        }

        fallbackToPolling() {
            if (!this.isPollingFallback) {
                this.isPollingFallback = true;
                console.log('Starting polling fallback');
                this.startPolling();
            }
        }

        startPolling() {
            const pollStatus = async () => {
                try {
                    const response = await fetch(`/api/receipts/${this.receiptId}/status/`);
                    const data = await response.json();
                    
                    updateStatus(data.status, data.processing_notes);

                    if (data.status === 'ready_for_review' && data.redirect_url) {
                        setTimeout(() => {
                            window.location.href = data.redirect_url;
                        }, 2000);
                    } else if (data.status === 'completed') {
                        window.location.href = data.redirect_url || "{% url 'inventory:inventory_list' %}";
                    } else if (data.status !== 'error') {
                        setTimeout(pollStatus, 3000); // Poll every 3 seconds
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                    this.handleError('WystƒÖpi≈Ç b≈ÇƒÖd podczas komunikacji z serwerem.');
                }
            };

            // Start polling if not completed/error
            if (initialStatus !== 'ready_for_review' && initialStatus !== 'completed' && initialStatus !== 'error') {
                setTimeout(pollStatus, 2000);
            }
        }

        disconnect() {
            if (this.ws) {
                this.ws.close();
            }
        }
    }

    // Initialize real-time updates manager
    const uploadManager = new ReceiptUploadManager(receiptId);

    const statusMap = {
        'pending_ocr': { 
            text: 'Plik przes≈Çany', 
            description: 'Plik zosta≈Ç pomy≈õlnie przes≈Çany na serwer',
            progress: 15,
            info: 'Tw√≥j paragon zosta≈Ç bezpiecznie przes≈Çany na nasz serwer. Rozpoczynamy proces analizy.',
            color: 'blue',
            step: 'pending_ocr'
        },
        'processing_ocr': { 
            text: 'Rozpoznawanie tekstu', 
            description: 'Trwa wyodrƒôbnianie tekstu z obrazu paragonu...',
            progress: 35,
            info: 'U≈ºywamy zaawansowanej technologii OCR do rozpoznania tekstu z Twojego paragonu. Ten proces mo≈ºe potrwaƒá kilka sekund w zale≈ºno≈õci od jako≈õci obrazu.',
            color: 'blue',
            step: 'pending_ocr'
        },
        'ocr_completed': { 
            text: 'Tekst rozpoznany', 
            description: 'Tekst zosta≈Ç pomy≈õlnie wyodrƒôbniony z paragonu',
            progress: 45,
            info: 'Tekst z paragonu zosta≈Ç pomy≈õlnie rozpoznany. Teraz przekazujemy go do analizy przez sztucznƒÖ inteligencjƒô.',
            color: 'blue',
            step: 'ocr_completed'
        },
        'processing_parsing': { 
            text: 'Analiza AI', 
            description: 'Sztuczna inteligencja analizuje tekst i wyodrƒôbnia produkty...',
            progress: 65,
            info: 'Nasz zaawansowany model AI analizuje rozpoznany tekst, aby wyodrƒôbniƒá nazwy produkt√≥w, ich ilo≈õci i jednostki. To najwa≈ºniejszy etap procesu.',
            color: 'blue',
            step: 'ocr_completed'
        },
        'parsing_completed': { 
            text: 'Analiza zako≈Ñczona', 
            description: 'AI zako≈Ñczy≈Ça analizƒô i wyodrƒôbni≈Ça produkty',
            progress: 75,
            info: 'Analiza zosta≈Ça zako≈Ñczona! AI wyodrƒôbni≈Ça produkty z Twojego paragonu. Przygotowujemy dane do weryfikacji.',
            color: 'blue',
            step: 'parsing_completed'
        },
        'matching': { 
            text: 'Dopasowywanie produkt√≥w', 
            description: 'Dopasowywanie wyodrƒôbnionych produkt√≥w do katalogu...',
            progress: 85,
            info: 'System dopasowuje wyodrƒôbnione produkty do istniejƒÖcych pozycji w Twoim katalogu. U≈ºywamy zaawansowanych algorytm√≥w, aby znale≈∫ƒá najlepsze dopasowania.',
            color: 'blue',
            step: 'parsing_completed'
        },
        'matching_completed': { 
            text: 'Gotowe do weryfikacji', 
            description: 'Sprawd≈∫ i zatwierd≈∫ wyodrƒôbnione produkty',
            progress: 100,
            info: 'Proces analizy zosta≈Ç zako≈Ñczony! Teraz mo≈ºesz sprawdziƒá wyodrƒôbnione produkty i je zatwierdziƒá.',
            color: 'green',
            step: 'matching_completed'
        },
        'pending_inventory': { 
            text: 'Finalizacja w toku', 
            description: 'Produkty sƒÖ dodawane do Twojej spi≈ºarni...',
            progress: 100,
            info: 'Twoje produkty sƒÖ w≈Ça≈õnie dodawane do spi≈ºarni. Za chwilƒô zostaniesz przekierowany.',
            color: 'green',
            step: 'matching_completed'
        },
        'completed': { 
            text: 'Zako≈Ñczone', 
            description: 'Produkty zosta≈Çy dodane do Twojej spi≈ºarni',
            progress: 100,
            info: 'Gratulacje! Wszystkie produkty zosta≈Çy pomy≈õlnie dodane do Twojej spi≈ºarni.',
            color: 'green',
            step: 'matching_completed'
        },
        'error': { 
            text: 'WystƒÖpi≈Ç b≈ÇƒÖd', 
            description: 'Podczas przetwarzania wystƒÖpi≈Ç b≈ÇƒÖd',
            progress: 0,
            info: 'Niestety, podczas przetwarzania paragonu wystƒÖpi≈Ç b≈ÇƒÖd. Spr√≥buj ponownie lub skontaktuj siƒô z pomocƒÖ technicznƒÖ.',
            color: 'red',
            step: 'pending_ocr' // Default step for error, can be more specific if needed
        }
    };

    function updateStepVisual(stepElement, status) {
        const indicator = stepElement.querySelector('.step-indicator');
        const numberSpan = stepElement.querySelector('.step-number');
        const checkSpan = stepElement.querySelector('.step-check');
        const spinnerSpan = stepElement.querySelector('.step-spinner');

        // Reset all states
        indicator.className = 'step-indicator w-8 h-8 rounded-full border-2 flex items-center justify-center';
        if (numberSpan) numberSpan.classList.remove('hidden');
        if (checkSpan) checkSpan.classList.add('hidden');
        if (spinnerSpan) spinnerSpan.classList.add('hidden');

        if (status === 'completed') {
            // Completed step
            indicator.classList.add('border-green-500', 'bg-green-500');
            if (numberSpan) numberSpan.classList.add('hidden');
            if (checkSpan) checkSpan.classList.remove('hidden');
        } else if (status === 'active') {
            // Currently active step
            indicator.classList.add('border-blue-500', 'bg-blue-50');
            if (numberSpan) numberSpan.classList.add('hidden');
            if (spinnerSpan) spinnerSpan.classList.remove('hidden');
        } else {
            // Pending step
            indicator.classList.add('border-secondary-300');
        }
    }

    function updateAllSteps(currentStatus) {
        const steps = [
            { id: 'pending_ocr', displayOrder: 0 },
            { id: 'ocr_completed', displayOrder: 1 },
            { id: 'parsing_completed', displayOrder: 2 },
            { id: 'matching_completed', displayOrder: 3 }
        ];

        const statusToDisplayOrder = {
            'pending_ocr': 0,
            'processing_ocr': 0,
            'ocr_completed': 1,
            'processing_parsing': 1,
            'parsing_completed': 2,
            'matching': 2,
            'matching_completed': 3,
            'pending_inventory': 3,
            'completed': 3
        };

        const currentDisplayOrder = statusToDisplayOrder[currentStatus] !== undefined ? statusToDisplayOrder[currentStatus] : -1;

        steps.forEach((stepInfo) => {
            const stepElement = document.querySelector(`[data-step="${stepInfo.id}"]`);
            if (stepElement) {
                if (stepInfo.displayOrder < currentDisplayOrder) {
                    updateStepVisual(stepElement, 'completed');
                } else if (stepInfo.displayOrder === currentDisplayOrder) {
                    updateStepVisual(stepElement, 'active');
                } else {
                    updateStepVisual(stepElement, 'pending');
                }
            }
        });
    }

    function updateStatus(status, processingNotes = null) {
        const mapped = statusMap[status] || { 
            text: status, 
            description: 'Status nieznany',
            progress: 0,
            info: 'Trwa przetwarzanie...',
            color: 'blue',
            step: 'pending_ocr'
        };

        // Update status text and description
        currentStatusSpan.textContent = mapped.text;
        statusDescription.textContent = processingNotes || mapped.description;
        
        // Update progress bar
        progressBar.style.width = mapped.progress + '%';
        progressText.textContent = mapped.progress + '%';
        
        // Update process info
        processInfo.innerHTML = `<p>${mapped.info}</p>`;
        
        // Update status indicator color
        statusIndicator.className = `w-3 h-3 rounded-full animate-pulse bg-${mapped.color}-500`;
        
        // Update step visuals
        updateAllSteps(status);

        // Handle errors
        if (status === 'error') {
            errorText.textContent = processingNotes || 'WystƒÖpi≈Ç nieznany b≈ÇƒÖd podczas przetwarzania paragonu.';
            errorMessageDiv.style.display = 'block';
            statusIndicator.className = 'w-3 h-3 rounded-full bg-red-500';
            progressBar.classList.add('bg-red-500');
        } else {
            errorMessageDiv.style.display = 'none';
        }
    }

    async function checkStatus() {
        try {
            const response = await fetch(`/api/receipts/${receiptId}/status/`);
            const data = await response.json();

            updateStatus(data.status, data.processing_notes);

            if (data.status === 'matching_completed' && data.redirect_url) {
                setTimeout(() => {
                    window.location.href = data.redirect_url;
                }, 2000); // Wait 2 seconds to show completed state
            } else if (data.status === 'completed') {
                // If already completed, redirect immediately
                window.location.href = data.redirect_url || "{% url 'inventory:inventory_list' %}";
            } else if (data.status === 'error') {
                // Stay on this page and show error
            } else {
                setTimeout(checkStatus, 2000); // Poll every 2 seconds
            }
        } catch (error) {
            console.error('Error checking status:', error);
            errorText.textContent = 'WystƒÖpi≈Ç b≈ÇƒÖd podczas komunikacji z serwerem.';
            errorMessageDiv.style.display = 'block';
            statusIndicator.className = 'w-3 h-3 rounded-full bg-red-500';
            progressBar.classList.add('bg-red-500');
        }
    }

    // Initial status update and start polling
    updateStatus(initialStatus, initialProcessingNotes);
    if (initialStatus !== 'matching_completed' && initialStatus !== 'completed' && initialStatus !== 'error') {
        setTimeout(checkStatus, 2000);
    }
</script>
{% endblock %}